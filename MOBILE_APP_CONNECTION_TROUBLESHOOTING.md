# 移动端应用无法连接后端问题排查指南

## 问题现象
APK安装后，登录时点击登录按钮，后端API服务器没有接收到前端发来的请求。

## 根本原因分析

### 1. 网络配置问题
- **IP地址不匹配**：移动端硬编码的IP地址在用户网络环境中不可达
- **网络安全策略**：Android默认不允许HTTP明文传输
- **防火墙阻拦**：后端服务器防火墙可能阻止外部访问

### 2. 后端配置问题
- **绑定地址错误**：后端可能只绑定到127.0.0.1，无法接受外部连接
- **CORS配置**：跨域请求被阻止
- **缺少健康检查端点**：移动端无法测试连接

## 解决方案

### 步骤1：确保后端正确配置

#### 1.1 检查后端绑定地址
确保后端服务器绑定到 `0.0.0.0:8000` 而不是 `127.0.0.1:8000`：

```python
# FastAPI示例
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)  # 不要使用127.0.0.1
```

#### 1.2 添加健康检查端点
在后端添加 `/health` 端点：

```python
@app.get("/health")
async def health_check():
    return {"status": "ok", "timestamp": datetime.utcnow().isoformat()}
```

#### 1.3 配置CORS
确保CORS允许移动端访问：

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 开发环境可以使用*，生产环境应限制具体域名
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 步骤2：检查网络连通性

#### 2.1 确认后端IP地址
在运行后端的电脑上执行：
```bash
ipconfig  # Windows
ifconfig  # Linux/Mac
```
找到正确的局域网IP地址（通常是192.168.x.x）

#### 2.2 测试网络连通性
在移动设备上：
1. 连接到与后端服务器相同的WiFi网络
2. 使用浏览器访问：`http://[后端IP]:8000/health`
3. 如果无法访问，检查防火墙设置

### 步骤3：使用移动端调试工具

#### 3.1 启用调试模式
在移动端应用中：
1. 打开应用
2. 在登录页面右上角点击设置图标（齿轮）
3. 进入网络调试面板

#### 3.2 测试连接
在调试面板中：
1. 点击"测试健康检查"按钮
2. 点击"测试登录API"按钮
3. 查看连接结果和错误信息

#### 3.3 手动配置API地址
如果自动检测失败：
1. 在调试面板中手动输入正确的API地址
2. 格式：`http://[后端IP]:8000`
3. 点击"保存配置"

### 步骤4：Android网络权限

已经配置的权限：
- ✅ `android.permission.INTERNET` - 网络访问权限
- ✅ `android:usesCleartextTraffic="true"` - 允许HTTP明文传输
- ✅ `android:networkSecurityConfig` - 网络安全配置

### 步骤5：常见问题解决

#### 问题1：连接超时
**原因**：IP地址不正确或网络不通
**解决**：
1. 确认后端IP地址
2. 检查WiFi连接
3. 尝试ping后端IP

#### 问题2：连接被拒绝
**原因**：后端未启动或端口被占用
**解决**：
1. 确认后端服务正在运行
2. 检查端口8000是否被占用
3. 尝试重启后端服务

#### 问题3：CORS错误
**原因**：跨域请求被阻止
**解决**：
1. 检查后端CORS配置
2. 确保允许移动端域名
3. 检查请求头设置

#### 问题4：SSL/TLS错误
**原因**：HTTPS配置问题
**解决**：
1. 开发环境使用HTTP
2. 确保网络安全配置正确
3. 检查证书设置

## 调试步骤

### 1. 后端调试
```bash
# 启动后端时添加详细日志
uvicorn main:app --host 0.0.0.0 --port 8000 --log-level debug
```

### 2. 网络调试
```bash
# 检查端口是否开放
netstat -an | findstr :8000

# 测试连接
curl http://[后端IP]:8000/health
```

### 3. 移动端调试
1. 使用Chrome DevTools连接移动设备
2. 查看Console日志
3. 检查Network请求

## 快速解决方案

如果急需解决，按以下顺序尝试：

1. **重启后端服务**，确保绑定到0.0.0.0:8000
2. **确认IP地址**，在移动端手动配置正确的API地址
3. **检查防火墙**，临时关闭防火墙测试
4. **使用调试工具**，在移动端查看详细错误信息
5. **检查WiFi连接**，确保移动设备和后端在同一网络

## 预防措施

1. **使用动态IP检测**：应用会自动检测可用的API地址
2. **提供手动配置**：用户可以手动设置API地址
3. **添加连接测试**：定期测试API连接状态
4. **详细错误提示**：显示具体的连接错误信息

## 联系支持

如果以上步骤都无法解决问题，请提供：
1. 后端服务器IP地址
2. 移动端调试信息
3. 网络环境描述
4. 具体错误信息
